
<%- include partials/header -%>

<%
function toNumber(value) {
  var parsed = Number(value);
  return isNaN(parsed) ? null : parsed;
}

var cityTimezoneOffset = toNumber(data && data[0] && data[0].timezone);
if (cityTimezoneOffset === null) {
  cityTimezoneOffset = toNumber(data && data[1] && data[1].city && data[1].city.timezone);
}
if (cityTimezoneOffset === null) {
  cityTimezoneOffset = 0;
}

function dateInCityTimezone(timestamp) {
  var unix = toNumber(timestamp);
  if (unix === null) {
    return null;
  }
  var date = new Date((unix + cityTimezoneOffset) * 1000);
  if (isNaN(date.getTime())) {
    return null;
  }
  return date;
}

function formatDayLabel(timestamp) {
  var date = dateInCityTimezone(timestamp);
  if (!date) {
    return '';
  }
  return date.toLocaleDateString('fr-CA', {
    weekday:'long',
    day:'numeric',
    month:'long',
    year:'numeric',
    timeZone:'UTC'
  });
}

function dayKeyFromTimestamp(timestamp) {
  var date = dateInCityTimezone(timestamp);
  if (!date) {
    return null;
  }
  var year = String(date.getUTCFullYear());
  var month = String(date.getUTCMonth() + 1).padStart(2, '0');
  var dayValue = String(date.getUTCDate()).padStart(2, '0');
  return year + '-' + month + '-' + dayValue;
}

function formatHour(timestamp) {
  var date = dateInCityTimezone(timestamp);
  if (!date) {
    return '';
  }
  return String(date.getUTCHours()) + "h";
}

function formatSnowAmount(snow) {
  if (!snow) {
    return null;
  }
  if (typeof snow === 'number' && !isNaN(Number(snow))) {
    return { amount: Math.round(Number(snow) * 10) / 10, label: '3h' };
  }
  var hasOneHour = Object.prototype.hasOwnProperty.call(snow, '1h');
  var hasThreeHour = Object.prototype.hasOwnProperty.call(snow, '3h');
  var key = hasOneHour ? '1h' : (hasThreeHour ? '3h' : null);
  if (!key) {
    return null;
  }
  var parsed = Number(snow[key]);
  if (isNaN(parsed)) {
    return null;
  }
  return { amount: Math.round(parsed * 10) / 10, label: key };
}

function formatSunTime(timestamp) {
  var date = dateInCityTimezone(timestamp);
  if (!date) {
    return null;
  }
  return date.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit', timeZone: 'UTC' });
}
%>

<!--

      current data

  -->
     <div class="container">
        <h3><%=data[0].name%>, <%=data[0].sys.country%></h3>
        <h3> <%=formatDayLabel(data[0].dt)%> </h3>
        <span class="current-data">
            <img class="big-icon current-data" src="http://openweathermap.org/img/wn/<%=data[0].weather[0].icon%>@2x.png" alt=""/>
            <div class='current-weather'>
                <h1 class='degre'> <%= Math.round(data[0].main.temp) %></h1>
                <h2><%= data[0].weather[0].description %></h2>
                <% var sunriseTime = formatSunTime(data[0].sys && data[0].sys.sunrise); %>
                <% var sunsetTime = formatSunTime(data[0].sys && data[0].sys.sunset); %>
                <% if (sunriseTime || sunsetTime) { %>
                  <div class="sun-cycle">
                    <span class="sun-context">Soleil</span>
                    <% if (sunriseTime) { %>
                      <span class="sun-time sunrise">Lever: <strong><%= sunriseTime %></strong></span>
                    <% } %>
                    <% if (sunsetTime) { %>
                      <span class="sun-time sunset">Coucher: <strong><%= sunsetTime %></strong></span>
                    <% } %>
                  </div>
                <% } %>
                <% var currentSnow = formatSnowAmount(data[0].snow); %>
                <% if (currentSnow) { %>
                  <p class="snow-accumulation">Neige (<%= currentSnow.label %>) : <%= currentSnow.amount %> mm</p>
                <% } %>
            </div>
        </span>
     </div>

<!--
      form pour selectionner les previsions de la journee courrante ou le lendemain

  -->
     <div class="container">
        <form action="/" method="post">
        <div class='form-group'>
          <div class="btn-group">
              <%if (day=='today') { %>
                <button style='opacity:60%'class='button active' name='button' value='today' onclick='this.form.submit()'>Aujourdh'ui</button><!-- to prevent space betwwen button
                --><button  class='button' name='button' value='tomorrow' onclick='this.form.submit()'>Demain</button>
                <input type="hidden" name="city" value=<%=city%>>
                <input type="hidden" name="day" value=<%=day%>>
              <% } else { %>
                <button  class='button' name='button' value='today' onclick='this.form.submit()'>Aujourdh'ui</button><!-- to prevent space betwwen button
                --><button style='opacity:60%'  class='button active' name='button' value='tomorrow'onclick='this.form.submit()'>Demain</button>
                <input type="hidden" name="city" value=<%=city%>>
                <input type="hidden" name="day" value=<%=day%>>
              <%}%>
        </div>
        </div>
          </form>
    </div>

<!--

    affichage des previsions horaire (forecast data)

  -->
    <div class="forecast">
      <% var todayKey = dayKeyFromTimestamp(data[0].dt); %>
      <% var tomorrowKey = dayKeyFromTimestamp((toNumber(data[0].dt) || 0) + 86400); %>
      <% var targetDayKey = day === 'today' ? todayKey : tomorrowKey; %>
      <% data[1].list.forEach(function(item){ %>
          <% if (dayKeyFromTimestamp(item.dt) === targetDayKey) {%>
            <div class='forecast-group'>
              <div class='forecast-hour'><%= formatHour(item.dt) %></div>
              <div><img class="forecast-image" src="http://openweathermap.org/img/wn/<%=item.weather[0].icon%>@2x.png" alt=""></div>
              <div class='forecast-degre degre'><%= Math.round(item.main.temp) %></div>
              <% var forecastSnow = formatSnowAmount(item.snow); %>
              <% if (forecastSnow) { %>
                <div class="snow-accumulation small">Neige: <%= forecastSnow.amount %> mm (<%= forecastSnow.label %>)</div>
              <% } %>
            </div>
          <%}%>
      <% }); %>
    </div>
</body>
</html>
