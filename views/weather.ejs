
<%- include partials/header -%>

<%
function formatSnowAmount(snow) {
  if (!snow) {
    return null;
  }
  if (typeof snow === 'number' && !isNaN(Number(snow))) {
    return { amount: Math.round(Number(snow) * 10) / 10, label: '3h' };
  }
  var hasOneHour = Object.prototype.hasOwnProperty.call(snow, '1h');
  var hasThreeHour = Object.prototype.hasOwnProperty.call(snow, '3h');
  var key = hasOneHour ? '1h' : (hasThreeHour ? '3h' : null);
  if (!key) {
    return null;
  }
  var parsed = Number(snow[key]);
  if (isNaN(parsed)) {
    return null;
  }
  return { amount: Math.round(parsed * 10) / 10, label: key };
}

function formatSunTime(timestamp) {
  if (!timestamp) {
    return null;
  }
  var date = new Date(Number(timestamp) * 1000);
  if (isNaN(date.getTime())) {
    return null;
  }
  return date.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' });
}
%>

<!--

      current data

  -->
     <div class="container">
        <h3><%=data[0].name%>, <%=data[0].sys.country%></h3>
        <% var options = {day:'numeric',month:'long',year:'numeric'}; %>
        <h3> <%=new Date(data[0].dt*1000).toLocaleDateString('fr-CA',options)%> </h3>
        <span class="current-data">
            <img class="big-icon current-data" src="http://openweathermap.org/img/wn/<%=data[0].weather[0].icon%>@2x.png" alt=""/>
            <div class='current-weather'>
                <h1 class='degre'> <%= Math.round(data[0].main.temp) %></h1>
                <h2><%= data[0].weather[0].description %></h2>
                <% var sunriseTime = formatSunTime(data[0].sys && data[0].sys.sunrise); %>
                <% var sunsetTime = formatSunTime(data[0].sys && data[0].sys.sunset); %>
                <% if (sunriseTime || sunsetTime) { %>
                  <div class="sun-cycle">
                    <% if (sunriseTime) { %>
                      <span class="sun-time sunrise">Lever: <strong><%= sunriseTime %></strong></span>
                    <% } %>
                    <% if (sunsetTime) { %>
                      <span class="sun-time sunset">Coucher: <strong><%= sunsetTime %></strong></span>
                    <% } %>
                  </div>
                <% } %>
                <% var currentSnow = formatSnowAmount(data[0].snow); %>
                <% if (currentSnow) { %>
                  <p class="snow-accumulation">Neige (<%= currentSnow.label %>) : <%= currentSnow.amount %> mm</p>
                <% } %>
            </div>
        </span>
     </div>

<!--
      form pour selectionner les previsions de la journee courrante ou le lendemain

  -->
     <div class="container">
        <form action="/" method="post">
        <div class='form-group'>
          <div class="btn-group">
              <%if (day=='today') { %>
                <button style='opacity:60%'class='button active' name='button' value='today' onclick='this.form.submit()'>Aujourdh'ui</button><!-- to prevent space betwwen button
                --><button  class='button' name='button' value='tomorrow' onclick='this.form.submit()'>Demain</button>
                <input type="hidden" name="city" value=<%=city%>>
                <input type="hidden" name="day" value=<%=day%>>
              <% } else { %>
                <button  class='button' name='button' value='today' onclick='this.form.submit()'>Aujourdh'ui</button><!-- to prevent space betwwen button
                --><button style='opacity:60%'  class='button active' name='button' value='tomorrow'onclick='this.form.submit()'>Demain</button>
                <input type="hidden" name="city" value=<%=city%>>
                <input type="hidden" name="day" value=<%=day%>>
              <%}%>
        </div>
        </div>
          </form>
    </div>

<!--

    affichage des previsions horaire (forecast data)

  -->
    <div class="forecast">
      <% todayDT    = new Date(data[0].dt*1000) %>
      <% tomorrowDT = new Date(); tomorrowDT.setDate(todayDT.getDate() + 1) %>
      <% if  (day=='today') {targetDate=todayDT.getDate()} else {targetDate=tomorrowDT.getDate()}%>
      <% data[1].list.forEach(function(item){ %>
          <% if (new Date(item.dt*1000).getDate()==targetDate) {%>
            <div class='forecast-group'>
              <div class='forecast-hour'><%= new Date(item.dt*1000).getHours()+"h" %></div>
              <div><img class="forecast-image" src="http://openweathermap.org/img/wn/<%=item.weather[0].icon%>@2x.png" alt=""></div>
              <div class='forecast-degre degre'><%= Math.round(item.main.temp) %></div>
              <% var forecastSnow = formatSnowAmount(item.snow); %>
              <% if (forecastSnow) { %>
                <div class="snow-accumulation small">Neige: <%= forecastSnow.amount %> mm (<%= forecastSnow.label %>)</div>
              <% } %>
            </div>
          <%}%>
      <% }); %>
    </div>
</body>
</html>
